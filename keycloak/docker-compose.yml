services:
  keycloak:
    image: quay.io/keycloak/keycloak:25.0.5
    container_name: keycloak
    command:
      - start-dev # Gunakan start-dev untuk development (lebih longgar security check-nya)
      # - --features=hostname:v1 # Tidak wajib di versi 25 jika config benar, tapi boleh dibiarkan
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_DB=postgres
      - KC_DB_URL_HOST=postgres
      - KC_DB_URL_DATABASE=keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=keycloak

      # Network & Proxy
      - KC_HTTP_ENABLED=true
      - KC_PROXY=edge  # Gunakan 'edge' saat di balik port mapping Docker

      # --- BAGIAN PENTING YANG DIPERBAIKI ---
      # URL ini harus sesuai dengan apa yang Anda ketik di BROWSER
      - KC_HOSTNAME_URL=http://nb631.local:7777
      - KC_HOSTNAME_ADMIN_URL=http://nb631.local:7777
      - KC_HOSTNAME_STRICT=false
      - KC_HOSTNAME_STRICT_HTTPS=false
      # --------------------------------------

    ports:
      - "7777:8080"
    networks:
      - keycloak-net
    depends_on:
      - postgres

  # Service postgres tetap sama...
  postgres:
    image: postgres:16.3
    container_name: postgres
    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=keycloak
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - keycloak-net

volumes:
  postgres_data:
    driver: local

networks:
  keycloak-net:
    driver: bridge
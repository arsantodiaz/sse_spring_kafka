<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Report Status</title>
    <!-- TAG BARU UNTUK FAVICON -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
</head>
<body>
    <h1>Report Status</h1>
    <p>Report ID: <b th:text="${reportId}"></b></p>
    <div id="status-container">
        <p>Status: <span id="status">PENDING</span></p>
        <p>Message: <span id="message">Waiting to be processed...</span></p>
    </div>
    <div id="download-link" style="display:none;">
        <a href="#">Download Report</a>
    </div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', () => {
            if ('Notification' in window && Notification.permission !== 'granted') {
                Notification.requestPermission();
            }
        });

        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: '/favicon.svg' // Menggunakan SVG baru
                });
            }
        }

        const reportId = /*[[${reportId}]]*/ 'default-id';
        const eventSource = new EventSource(`/status/${reportId}`);

        eventSource.addEventListener('statusUpdate', function(event) {
            const job = JSON.parse(event.data);
            document.getElementById('status').innerText = job.status;
            document.getElementById('message').innerText = job.message;

            if (job.status === 'COMPLETED') {
                const downloadLink = document.getElementById('download-link');
                const a = downloadLink.querySelector('a');
                a.href = `/download/${job.filename}`;
                a.innerText = `Download ${job.filename}`;
                downloadLink.style.display = 'block';

                showNotification('Report Ready!', `Your report (${job.filename}) is now available for download.`);

                eventSource.close();
            }

            if (job.status === 'FAILED') {
                showNotification('Report Failed', `Failed to generate report for ID: ${job.id}`);
                eventSource.close();
            }
        });

        eventSource.onerror = function() {
            document.getElementById('message').innerText = 'Connection to server lost.';
            eventSource.close();
        };
    </script>
</body>
</html>

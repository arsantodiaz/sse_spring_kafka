version: '3.8'

services:
  postgres:
    image: postgres:16.3
    container_name: postgres
    networks:
      - poc-net
    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=keycloak
    volumes:
      - postgres_data:/var/lib/postgresql/data

  keycloak:
    # Use the official image directly, do not build
    image: quay.io/keycloak/keycloak:25.0.5
    container_name: keycloak
    command: start-dev
    networks:
      - poc-net
    environment:
      # Database config using the 'postgres' service name
      - KC_DB=postgres
      - KC_DB_URL_HOST=postgres
      - KC_DB_URL_DATABASE=keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=keycloak
      # Admin credentials
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      # Use localhost for both backend and frontend, as it's simpler and works
      # when Spring is also in a container on the same network.
      - KC_HOSTNAME_ADMIN_URL=http://localhost:7777
      - KC_HOSTNAME_URL=http://localhost:7777
      - KC_PROXY=passthrough
    ports:
      - "7777:8080"
    depends_on:
      - postgres

  spring-ui:
    # Build from the 'spring-keycloack1' sub-directory
    build: ./spring-keycloack1
    container_name: spring-ui
    networks:
      - poc-net
    environment:
      # Connect to Keycloak using its service name 'keycloak' and internal port 8080
      - SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KEYCLOAK_ISSUER_URI=http://keycloak:8080/realms/my-app-realm
      # Client secret from the .env file
      - KEYCLOAK_CLIENT_SECRET=6Am4MvfGGIyDH7zt9z6Y4pL1k1LR3Qhf
    ports:
      - "8090:8090"
    depends_on:
      - keycloak

networks:
  poc-net:
    driver: bridge

volumes:
  postgres_data:
    driver: local
